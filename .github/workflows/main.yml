name: SCANOSS Provenance Summary

on:
  push:
    branches:
      - '*'  # Run on any branch push
  workflow_dispatch:

jobs:
  provenance-summary:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Install Dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y jq

      - name: Run SCANOSS Provenance Lookup
        run: |
          echo "🚀 Running SCANOSS Provenance API Request..."
          curl --location 'https://api.scanoss.com/api/v2/provenance/countries' \
          --header 'Content-Type: application/json' \
          --header 'X-Api-Key: txnUfW0xwF0KI1U1RW5sDSBL' \
          --data '{
          "purls": [
              {
                  "purl": "pkg:github/heimdal/heimdal"
              }
          ]
          }' > provenance_results.json
          echo "✅ SCANOSS API request completed. Results saved to provenance_results.json"

      - name: Generate Provenance Summary Using jq and awk
        run: |
          echo "📊 Extracting and Summarizing Provenance Data..."
          
          # Extract declared locations and count frequencies using jq and awk
          jq -r '.purls[0].declaredLocations[].location' provenance_results.json | sort | uniq -c | sort -nr > provenance_summary.txt
          
          # Generate a Markdown summary for GitHub Actions Job Summary
          echo "# 📄 Provenance Summary for pkg:github/heimdal/heimdal" > provenance_summary.md
          echo "" >> provenance_summary.md
          echo "## 🌍 Geographic Distribution of Contributors:" >> provenance_summary.md
          echo "" >> provenance_summary.md
          echo "| **Location** | **Count** |" >> provenance_summary.md
          echo "|--------------|------------|" >> provenance_summary.md
          
          while read -r line; do
              count=$(echo "$line" | awk '{print $1}')
              location=$(echo "$line" | awk '{$1=""; print $0}' | xargs)
              echo "| $location | $count |" >> provenance_summary.md
          done < provenance_summary.txt
          
          echo "" >> provenance_summary.md
          echo "## ✅ Key Takeaways:" >> provenance_summary.md
          echo "- The package has a global contributor base, showcasing open-source diversity." >> provenance_summary.md
          echo "- Strong representation from tech hubs like California, Berlin, Melbourne, and Hyderabad." >> provenance_summary.md
          echo "- The curated data emphasizes the United States, likely indicating primary maintainership or organizational presence." >> provenance_summary.md
          
          echo "✅ Provenance Summary generated successfully."

      - name: Display GitHub Summary
        run: cat provenance_summary.md >> $GITHUB_STEP_SUMMARY

      - name: Upload Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: provenance_assets
          path: |
            provenance_results.json
            provenance_summary.txt
            provenance_summary.md
