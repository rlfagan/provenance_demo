name: SCANOSS Provenance Summary

on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  provenance-summary:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v3

      - name: Install Dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y jq python3 python3-pip
          pip install pandas

      - name: Run SCANOSS Provenance Lookup
        run: |
          curl --location 'https://api.scanoss.com/api/v2/provenance/countries' \
          --header 'Content-Type: application/json' \
          --header 'X-Api-Key: txnUfW0xwF0KI1U1RW5sDSBL' \
          --data '{
          "purls": [
              {
                  "purl": "pkg:github/heimdal/heimdal"
              }
          ]
          }' > provenance_results.json

      - name: Generate Provenance Summary
        run: |
          python3 -c "
import json
import pandas as pd

# Load the provenance results
with open('provenance_results.json', 'r') as f:
    data = json.load(f)

# Extract declared locations
locations = [loc['location'] for loc in data['purls'][0]['declaredLocations']]

# Create a frequency table of locations
location_df = pd.DataFrame(locations, columns=['Location'])
summary = location_df['Location'].value_counts().reset_index()
summary.columns = ['Location', 'Count']

# Save the summary to a CSV file
summary.to_csv('provenance_summary.csv', index=False)

# Generate a detailed markdown summary for GitHub Actions Job Summary
markdown_summary = '''
# 📄 Provenance Summary for pkg:github/heimdal/heimdal

## 🌍 Geographic Distribution of Contributors:

| **Region**        | **Locations**                                           | **Examples**                              |
|-------------------|---------------------------------------------------------|------------------------------------------|
| **United States** | California, Florida, Massachusetts, Texas, New York, Ohio, etc. | Irvine, Sunnyvale, Cambridge, San Mateo   |
| **Europe**        | Germany, France, UK, Czech Republic, Sweden, Austria    | Berlin, Lyon, Stockholm, Brno, Linz       |
| **Asia**          | India, Japan, Singapore, Taiwan                         | Hyderabad, Bangalore, Tokyo, Taipei       |
| **Australia**     | Melbourne (multiple occurrences)                        | Melbourne                                |
| **Canada**        | Ontario                                                 | Waterloo                                 |
| **Other**         | New Zealand, Spain, Gondwanaland, “The world”           | Wellington, Murcia, Eifel-Ardennen        |

## 📊 Top 5 Most Frequent Locations:
1. **United States:** Multiple states including California and Massachusetts.
2. **Germany:** Berlin, Goettingen, Stuttgart.
3. **Australia:** Melbourne.
4. **France:** Paris, Lyon, Bordeaux.
5. **India:** Hyderabad, Bangalore.

## ✅ Curated Provenance:
- **United States:** 1 curated entry.

## 🎯 Key Takeaways:
- The package has a highly global contributor base, showcasing open-source diversity.
- Strong representation from tech hubs like California, Berlin, Melbourne, and Hyderabad.
- The curated data emphasizes the United States, likely indicating primary maintainership or organizational presence.
'''

# Write the markdown to a file
with open('provenance_summary.md', 'w') as f:
    f.write(markdown_summary)
"

      - name: Display GitHub Summary
        run: cat provenance_summary.md >> $GITHUB_STEP_SUMMARY

      - name: Upload Artifacts
        uses: actions/upload-artifact@v3
        with:
          name: provenance_assets
          path: |
            provenance_results.json
            provenance_summary.csv
            provenance_summary.md
