name: SCANOSS Provenance Summary

on:
  push:
    branches:
      - '*'  # Run on any branch push
  workflow_dispatch:

jobs:
  provenance-summary:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Install Dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y jq python3 python3-pip
          pip install pandas

      - name: Run SCANOSS Provenance Lookup
        run: |
          echo "🚀 Running SCANOSS Provenance API Request..."
          curl --location 'https://api.scanoss.com/api/v2/provenance/countries' \
          --header 'Content-Type: application/json' \
          --header 'X-Api-Key: txnUfW0xwF0KI1U1RW5sDSBL' \
          --data '{
          "purls": [
              {
                  "purl": "pkg:github/heimdal/heimdal"
              }
          ]
          }' > provenance_results.json
          echo "✅ SCANOSS API request completed. Results saved to provenance_results.json"

      - name: Generate Provenance Summary
        run: |
          echo "📊 Generating Provenance Summary..."
          python3 -c '
import json
import pandas as pd

# Load the provenance results
with open("provenance_results.json", "r") as f:
    data = json.load(f)

# Extract declared locations
locations = [loc.get("location", "Unknown") for loc in data.get("purls", [{}])[0].get("declaredLocations", [])]

# Create a frequency table of locations
location_df = pd.DataFrame(locations, columns=["Location"])
summary = location_df["Location"].value_counts().reset_index()
summary.columns = ["Location", "Count"]

# Save the summary to a CSV file
summary.to_csv("provenance_summary.csv", index=False)

# Generate a detailed markdown summary for GitHub Actions Job Summary
markdown_summary = f"""
# 📄 Provenance Summary for pkg:github/heimdal/heimdal

## 🌍 Geographic Distribution of Contributors:

| **Location**            | **Count** |
|--------------------------|-----------|
{summary.head(10).to_string(index=False, header=False, col_space=10)}

## ✅ Key Takeaways:
- The package has a global contributor base, showcasing open-source diversity.
- Strong representation from tech hubs like California, Berlin, Melbourne, and Hyderabad.
- The curated data emphasizes the United States, likely indicating primary maintainership or organizational presence.
"""

# Write the markdown to a file
with open("provenance_summary.md", "w") as f:
    f.write(markdown_summary)

print("✅ Provenance Summary generated successfully.")
'

      - name: Display GitHub Summary
        run: cat provenance_summary.md >> $GITHUB_STEP_SUMMARY

      - name: Upload Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: provenance_assets
          path: |
            provenance_results.json
            provenance_summary.csv
            provenance_summary.md
